<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circle of Chords</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <!-- <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script> -->
    <script src="tone.js"></script>
</head>
<script>
    //create a synth and connect it to the main output
    const synth = new Tone.PolySynth().toDestination();
    var notes = {};

    //attach a click listener to a play button
    var buttons = document.querySelectorAll('button')
    for(let i = 0; i<buttons.length; i++) {
        buttons[i].addEventListener('click', async () => {
	    await Tone.start();
	    console.log('audio is ready');
    })
    }
    var pressedNotes = [];
    var noteButtons = document.querySelectorAll('.circle-container button');
    var noteFundamentals = ['C4', 'G4', 'D4', 'A4', 'E4', 'B4', 'F#4', 'C#4', 'Ab4', 'Eb4', 'Bb4', 'F4'];
    var duration = '8n';
    var counter = 0;

    function remove(element) {
        element.remove();
    }

    function playSequence() {
        var baseNotes = document.querySelectorAll('.note');
        for (let i=0; i<baseNotes.length; i++) {
            // notesToPlay = [Tone.Frequency(String(baseNotes[i].innerHTML) + octave), Tone.Frequency(String(baseNotes[i].innerHTML) + octave).transpose(4), Tone.Frequency(String(baseNotes[i].innerHTML) + octave).transpose(7)]
            // synth.triggerAttackRelease(notesToPlay, duration);
        }
    }

    function song(time) {
        // Set frequency for chord base
        let tf = new Tone.Frequency(document.querySelectorAll('.note')[counter].innerHTML);
        let mode = document.querySelectorAll('.note')[counter].getAttribute('mode');
        let duration = document.querySelectorAll('.note')[counter].getAttribute('duration');
        console.log("Duration = " + duration);
        if(mode == "minor") {
            //Play minor triad
            synth.triggerAttackRelease(tf, duration, time);
	        synth.triggerAttackRelease(tf.transpose(3), duration, time);
	        synth.triggerAttackRelease(tf.transpose(7), duration, time);
        } else {
            // Play major triad
	        synth.triggerAttackRelease(tf, duration, time);
	        synth.triggerAttackRelease(tf.transpose(4), duration, time);
	        synth.triggerAttackRelease(tf.transpose(7), duration, time);
        }


        // Highlight current chord
        for (let i=0; i<document.querySelectorAll('.note').length; i++) {
            document.querySelectorAll('.note')[i].style.backgroundColor = "#CCC";
        }
        document.querySelectorAll('.note')[counter].style.backgroundColor = "#4A4";

	    counter = (counter +1)%document.querySelectorAll('.note').length;
    }

    function constructScale() {
        console.log("Constructing Scale");
        var octave = Number(document.querySelector('#octave').value)
        var mode = document.querySelector('#minMaj').value;
        var startFreq = Tone.Frequency(String(document.querySelector('#startingNote').value) + octave)
        var noteDisplayMode = document.querySelector('#noteOrFreq').value;
        var noteButtons = document.querySelectorAll('.circle-container button');
        var noteOffsets = [0, 7, 2, 9, 4, 11, 6, 1, 8, 3, 10, 5];
        for (let i =0; i<noteButtons.length; i++) {
            freq = startFreq.transpose(noteOffsets[i]);
            console.log(freq.toMidi());
            if(noteDisplayMode == "midi") {
                noteButtons[i].innerHTML = freq.toMidi();
            } else if (noteDisplayMode == "freq") {
                noteButtons[i].innerHTML = freq.toFrequency().toFixed(1);
            } else {
                noteButtons[i].innerHTML = freq.toNote();
            }

            
            
            console.log(freq.toNote());
            var notesToPlay = [];
            noteButtons[i].onclick= function (){

                if(mode == 'minor') {
                    notesToPlay = [Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]), Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(3), Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(7)]
                    synth.triggerAttackRelease(notesToPlay, '8n');
                    
                    console.log("Minor triad");
                    console.log(Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).toNote() + " " + Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(4).toNote() + " " + Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(7).toNote())
            
                }
                else {
                    notesToPlay = [Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]), Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(4), Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(7)];
                    synth.triggerAttackRelease(notesToPlay, '8n');
                console.log(Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).toNote() + " " + Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(4).toNote() + " " + Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(7).toNote())
            
                }

                var newNote = document.createElement('div');
                newNote.classList.add("note");
                newNote.setAttribute("mode", mode);
                newNote.setAttribute("duration", '8n');
                newNote.setAttribute("draggable", "true");
                newNote.ondragstart = (event) => {
                    event.dataTransfer.setData('text/plain', event.target.id);
                    event.currentTarget.style.backgroundColor = 'yellow';
                };
                newNote.innerHTML = notesToPlay[0].toNote();
                newNote.onclick = function () {this.remove()};
                document.querySelector('.notePlaylist').appendChild(newNote);

                }
        }
    }
    

</script>
<body>
    <h1>Circle of Chords</h1>
        <div id="options">
            <label for="startingNote">Choose starting note:</label>  
            <select name="startingNote" id="startingNote" onchange="constructScale()">
                <option value="Ab">Ab</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="Bb">Bb</option>
                <option value="B">B</option>
                <option value="C" selected>C</option>
                <option value="C#">C#</option>
                <option value="Db">Db</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="Eb">Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="Gb">Gb</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
            </select>
            <br>
            <label for="octave">Choose starting octave:</label>
            <input name="octave" id="octave" min="1" max="12" value="4" placeholder="4" onchange="constructScale()">
            <br>
            <label for="minMaj">Major or Minor:</label>  
            <select name="minMaj" id="minMaj" onchange="constructScale()">
            <option value="major">Major</option>
            <option value="minor">Minor</option>
            </select>
            <br>
            <label for="noteOrFreq">Display:</label>  
            <select name="noteOrFreq" id="noteOrFreq" onchange="constructScale()">
            <option value="note">Notes</option>
            <option value="freq">Frequency</option>
            <option value="midi">Midi</option>
            </select>
        </div>

    <div class='circle-container'>
        <!-- C, G, D, A, E, B (=C‚ô≠), F‚ôØ (=G‚ô≠), C‚ôØ (=D‚ô≠), A‚ô≠, E‚ô≠, B‚ô≠, F -->
        <button class='deg270' onclick="synth.triggerAttackRelease(['C4', 'E4', 'G4'], '8n');">C</button>
        <button class='deg300' onclick="synth.triggerAttackRelease(['G4', 'A4', 'D5'], '8n');">G</button>
        <button class='deg330' onclick="synth.triggerAttackRelease(['D4', 'F4', 'A4'], '8n');">D</button>
        <button class='deg0'>A</button>
        <button class='deg30'>E</button>
        <button class='deg60'>B</button>
        <button class='deg90'>F#</button>
        <button class='deg120'>C#</button>
        <button class='deg150'>A‚ô≠</button>
        <button class='deg180'>E‚ô≠</button>
        <button class='deg210'>B‚ô≠</button>
        <button class='deg240'>F</button>
        <!-- <button id="silence">ü§´</button> -->
        <div class="deg240small">IV</div>
        <div class="deg270small">I</div>
        <div class="deg300small">V</div>
        <div class="deg330small">ii</div>
        <div class="deg0small">vi</div>
        <div class="deg30small">iii</div>
        <div class="deg60small">vii¬∞</div>

    </div>
    <div id="playbackControls" class="controls">
        <div>Sequence controls</div>
        <button onclick="Tone.Transport.start()">‚ñ∂Ô∏è</button>
        <!-- <button onclick="playSequence()">‚ñ∂Ô∏è</button> -->
        <button onclick="Tone.Transport.stop()">‚è∏Ô∏è</button>
        <button onclick="Tone.Transport.stop(); document.querySelector('.notePlaylist').innerHTML = '';">‚ùå</button>
        <button>‚¨áÔ∏è</button>
    </div>
    <div id="durationControls" class="controls">
        <div>Duration controls</div>
        <button>1n</button>
        <button>2n</button>
        <button>4n</button>
        <button>8n</button>
    </div>
    <p id="pressedNotesParagraph"></p>
    <div class="notePlaylist"></div>
    <script>
        constructScale();

        window.addEventListener("keyup", function (event) {
        
        if (event.key !== undefined) {
            // Handle the event with KeyboardEvent.key
                if(event.key==1) {
                        document.querySelector('.deg270').click();
                    }
                    else if (event.key==2) {
                        document.querySelector('.deg330').click();
                    } else if (event.key==3) {
                        document.querySelector('.deg30').click();
                    } else if (event.key==4) {
                        document.querySelector('.deg240').click();
                    } else if (event.key==5) {
                        document.querySelector('.deg300').click();
                    } else if (event.key==6) {
                        document.querySelector('.deg0').click();
                    } else if (event.key==7) {
                        document.querySelector('.deg60').click();
                    }

        } else if (event.which !== undefined) {
            // Handle the event with KeyboardEvent.which
        }
        });    

        var counter = 0;
        var loopBeat = new Tone.Loop(song, '4n')
        loopBeat.start(0);

    </script>
</body>
</html>