<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circles of Fifth</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <!-- <script src="tone-ui.js"></script>
    <script src="components.js"></script> -->
</head>
<script>
    //create a synth and connect it to the main output (your speakers)
    const synth = new Tone.PolySynth().toDestination();


    //attach a click listener to a play button
    var buttons = document.querySelectorAll('button')
    for(let i = 0; i<buttons.length; i++) {
        buttons[i].addEventListener('click', async () => {
	    await Tone.start();
	    console.log('audio is ready');
    })
    }
    var pressedNotes = [];
    var noteButtons = document.querySelectorAll('.circle-container button');
    var noteFundamentals = ['C4', 'G4', 'D4', 'A4', 'E4', 'B4', 'F#4', 'C#4', 'Ab4', 'Eb4', 'Bb4', 'F4'];
    var duration = '8n';

    function remove(element) {
        element.remove();
    }

    function constructScale() {
        console.log("Constructing Scale");
        var octave = Number(document.querySelector('#octave').value)
        var mode = document.querySelector('#minMaj').value;
        var startFreq = Tone.Frequency(String(document.querySelector('#startingNote').value) + octave)
        var noteDisplayMode = document.querySelector('#noteOrFreq').value;
        var noteButtons = document.querySelectorAll('.circle-container button');
        var noteOffsets = [0, 7, 2, 9, 4, 11, 6, 1, 8, 3, 10, 5];
        for (let i =0; i<noteButtons.length; i++) {
            freq = startFreq.transpose(noteOffsets[i]);
            console.log(freq.toMidi());
            if(noteDisplayMode == "midi") {
                noteButtons[i].innerHTML = freq.toMidi();
            } else if (noteDisplayMode == "freq") {
                noteButtons[i].innerHTML = freq.toFrequency().toFixed(1);
            } else {
                noteButtons[i].innerHTML = freq.toNote();
            }
            
            console.log(freq.toNote());
            var notesToPlay = [];
            noteButtons[i].onclick= function (){

                if(mode == 'minor') {
                    notesToPlay = [Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]), Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(3), Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(7)]
                    synth.triggerAttackRelease(notesToPlay, '8n');
                    console.log("Minor triad");
                    console.log(Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).toNote() + " " + Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(4).toNote() + " " + Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(7).toNote())
            
                }
                else {
                    notesToPlay = [Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]), Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(4), Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(7)];
                    synth.triggerAttackRelease(notesToPlay, '8n');
                console.log(Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).toNote() + " " + Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(4).toNote() + " " + Tone.Frequency(String(document.querySelector('#startingNote').value) + octave).transpose(noteOffsets[i]).transpose(7).toNote())
            
                }
                // Prapagraph note logger
                // pressedNotes.push(notesToPlay[0]);
                // var pressedNotesString = "";
                // for (let i = 0; i<pressedNotes.length; i++) {
                //     pressedNotesString += (pressedNotes[i].toNote() + ", ")
                // }
                // document.querySelector('#pressedNotesParagraph').innerHTML = pressedNotesString;

                var newNote = document.createElement('div');
                newNote.className += "note";
                newNote.innerHTML = notesToPlay[0].toNote();
                newNote.onclick = function () {this.remove()};
                document.querySelector('.notePlaylist').appendChild(newNote);

                }

        }
    }
    

</script>
<body>
    <h1>Circle of Blitz</h1>
        <div id="options">
            <label for="startingNote">Choose starting note:</label>  
            <select name="startingNote" id="startingNote" onchange="constructScale()">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C" selected>C</option>
            <option value="D">D</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="G">G</option>
            </select>
            <br>
            <label for="octave">Choose starting octave:</label>
            <input name="octave" id="octave" min="1" max="12" value="4" placeholder="4" onchange="constructScale()">
            <br>
            <label for="minMaj">Major or Minor:</label>  
            <select name="minMaj" id="minMaj" onchange="constructScale()">
            <option value="major">Major</option>
            <option value="minor">Minor</option>
            </select>
            <br>
            <label for="noteOrFreq">Display:</label>  
            <select name="noteOrFreq" id="noteOrFreq" onchange="constructScale()">
            <option value="note">Notes</option>
            <option value="freq">Frequency</option>
            <option value="midi">Midi</option>
            </select>
            <br>
            <label for="bpm">BPM:</label>
            <input name="bpm" id="bpm" type="number" min="30" max="300" value="60" placeholder="60">
        </div>

    <div class='circle-container'>
        <!-- C, G, D, A, E, B (=C♭), F♯ (=G♭), C♯ (=D♭), A♭, E♭, B♭, F -->
        <button class='deg270' onclick="synth.triggerAttackRelease(['C4', 'E4', 'G4'], '8n');">C</button>
        <button class='deg300' onclick="synth.triggerAttackRelease(['G4', 'A4', 'D5'], '8n');">G</button>
        <button class='deg330' onclick="synth.triggerAttackRelease(['D4', 'F4', 'A4'], '8n');">D</button>
        <button class='deg0'>A</button>
        <button class='deg30'>E</button>
        <button class='deg60'>B</button>
        <button class='deg90'>F#</button>
        <button class='deg120'>C#</button>
        <button class='deg150'>A♭</button>
        <button class='deg180'>E♭</button>
        <button class='deg210'>B♭</button>
        <button class='deg240'>F</button>
        <div class="deg240small">IV</div>
        <div class="deg270small">I</div>
        <div class="deg300small">V</div>
        <div class="deg330small">ii</div>
        <div class="deg0small">vi</div>
        <div class="deg30small">iii</div>
        <div class="deg60small">vii°</div>

    </div>
    <div id="playbackControls">
        <button>▶️</button>
        <button>⏸️</button>
        <button onclick="document.querySelector('.notePlaylist').innerHTML = '';">❌</button>
    </div>
    <p id="pressedNotesParagraph"></p>
    <div class="notePlaylist"></div>
    <script>
        constructScale();
    //     for (let i=0; i< noteButtons.length; i++) {
	//         noteButtons[i].onclick= function (){
    //             // base note, monophonic
    //             //synth.triggerAttackRelease([noteFundamentals[i]], duration);
    //             // polyphonic triad
    //             var baseNote = Tone.Frequency(noteFundamentals[i]);
    //             synth.triggerAttackRelease([baseNote, baseNote.transpose(4), baseNote.transpose(7)], duration);
    //             console.log(baseNote.toNote() + " " + baseNote.transpose(4).toNote() + " " + baseNote.transpose(7).toNote())
    //         pressedNotes.push(noteFundamentals[i]);
    //         document.querySelector('#pressedNotesParagraph').innerHTML = pressedNotes;
    //         console.log(noteFundamentals[i]);
    // }
//}
    </script>
    <!-- <div id="content"></div>
    <script type="text/javascript">
		

		piano({
			parent: document.querySelector("#content"),
			polyphonic: true,
			noteon: note => synth.triggerAttack(note.name),
			noteoff: note => synth.triggerRelease(note.name)
		});
		
		ui({
			tone: synth,
			parent: document.querySelector("#content"),
		});
	</script> -->
</body>
</html>